<!DOCTYPE html>
<html lang="ja">

<head>
  <!-- 弄らない -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Learn how to use the Firebase platform on the Web">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Disable tap highlight on IE -->
  <meta name="msapplication-tap-highlight" content="no">
  <!-- Web Application Manifest -->
  <link rel="manifest" href="/manifest.json">
  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Easy Chat">
  <meta name="theme-color" content="#ff9800">
  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Easy Chat">
  <meta name="apple-mobile-web-app-status-bar-style" content="#ff9800">
  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.orange-indigo.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <!-- /弄らない -->

  <title>Sample_GoogleMap</title>
  <link rel="stylesheet" type="text/css" href="styles/main.css" />
</head>

<body>
  <div id="map"></div>
</body>

<!-- Initialize Firebase -->
<script defer src="https://www.gstatic.com/firebasejs/6.6.0/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/6.6.0/firebase-auth.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/6.6.0/firebase-firestore.js"></script>

<script defer src="/__/firebase/init.js"></script>

<script src="https://maps.google.com/maps/api/js?key=AIzaSyC35_MBRS8sEO3YOCUJFHJjnc7SpB_OQhs&language=ja"></script>
<script defer type="text/javascript" src="scripts/mapapi.js"></script>
<script defer type="text/javascript" src="scripts/main.js"></script>
<script>
    // ユーザーの端末がGeoLocation APIに対応しているかの判定
    // 対応している場合
    function method1() {
        if (navigator.geolocation) {
            // 現在地を取得
            var myPos = {};
            var date = new Date();
            navigator.geolocation.getCurrentPosition(

                // [第1引数] 取得に成功した場合の関数
                function(position) {
                    /* -------------------- My Info Set -------------------- */
                    // 取得データの整理
                    myData = position.coords;
                    // 自分のデータの整理
                    myPos['lat'] = myData.latitude;              // 緯度
                    myPos['lng'] = myData.longitude;             // 経度

                    // 未使用
                    // myPos['alt'] = myData.altitude;              // 高度
                    // myPos['accLatlng'] = myData.accuracy;        // 緯度経度の精度
                    // myPos['accAlt'] = myData.altitudeAccuracy;   // 高度の精度
                    // myPos['heading'] = myData.heading; // 地図の角度 default 0=北,90=東,180=南,270=西
                    // myPos['speed'] = myData.speed;     // ??

                    // 自分のピンを立てる処理
                    var myLatLng = new google.maps.LatLng(myPos['lat'], myPos['lng']); // 地図の中心座標

                    var Options = {
                        zoom: 15,             // 地図の縮尺値
                        center: myLatLng,     // 地図の中心座標
                        mapTypeId: 'roadmap'  // 地図の種類
                    };

                    // 共通設定
                    var displayMap = new google.maps.Map(document.getElementById('map'), Options);
                    var myMarker = new google.maps.Marker({
                        position: myLatLng,
                        map: displayMap
                    });
                    // 吹き出しコメントを設定
                    var hourStr = ('0' + date.getHours()).slice(-2);
                    var minStr = ('0' + date.getMinutes()).slice(-2);
                    var markTime = hourStr + ":" + minStr;
                    var userName = "Ninja" // 認証済アカウント or 入力された名前 から取得
                    var myContent = "[" + markTime + "] " + userName + " さん";
                    var myInfoWindow = new google.maps.InfoWindow({
                        content: myContent
                    });
                    // 吹き出しを開く
                    myInfoWindow.open(displayMap, myMarker);
                    /* -------------------- My Info Set -------------------- */

                    // 自分の位置をfirestoreに登録
                    var savedata = {'name':userName,
                                    'lat':myPos['lat'],
                                    'lng':myPos['lng'],
                                    'time':markTime };
                    dokoma.saveMarker(savedata);
                    /*
                    Dokoma.firestore.collection('userMarker').add({
                        name: userName,
                        lat: myPos['lat'],
                        lng: myPos['lng'],
                        time: markTime
                    })
                    .catch(function(error) {
                    console.error("Error adding document: ", error);
                    });
                    */

                    // 登録済みの位置データを取得


                    // マーカー共通設定
                    // 吹き出しが閉じられたら、マーカークリックで再び開くようにしておく
                    google.maps.event.addListener(myInfoWindow, "closeclick", function() {
                        google.maps.event.addListenerOnce(myMarker, "click", function(event) {
                            myInfoWindow.open(displayMap, myMarker);
                        });
                    });
                }
            )
        }
    }
</script>
</html>
